# Vatímetro inteligente de Iot al Barrio

El google sheets donde estamos haciendo las pruebas de recolleción de datoa es <link>


## Google Sheets
1. Crear un Google Sheets
2. Configura el archivo para que cualqueira con el link puede acceder al archivo
3. Extrae el ID del archivo de la URL
   ~~~shell
   https://docs.google.com/spreadsheets/d/18LgNUzvpz2nXAxljXm-M7lh4k4oUYM0yrNcw7t4t3cE/edit?usp=sharing
   GSS='18LgNUzvpz2nXAxljXm-M7lh4k4oUYM0yrNcw7t4t3cE'
   ~~~
4. 

## Google Apps Script

Por favor lee primero [Crea y administra implementaciones ](https://developers.google.com/apps-script/concepts/deployments?hl=es-419)

Petición:
~~~shell
DEPKEY=<"Llave de despliegue">
URL=https://script.google.com/macros/s/$DEPKEY/exec?hoja
~~~

~~~shell
curl -L $URL
curl -d "" -L $URL
DATA=$(./generador.sh 0 1024)
curl -H 'Content-Type: application/json' -d "$DATA" -L $URL?hoja=test
~~~

~~~shell
DATA='{"tamano":1024,"voltaje":[288,187,2661,2214,330,3852,2425,693,2813,3041,1888,494,1328,1259,3850,1116,2504,0,227,3733,3095,3648,3355,1639,2357,3332,36,2018,2055,3960,857,674,2867,1826,884,3623,2986,575,2053,4001,3002,1647,2003,234,2434,1600,1056,452,4071,1412,3532,845,2188,992,2270,612,3303,2304,2885,3591,3416,904,1075,639,3759,1470,1731,3097,617,3523,3870,3346,3451,1764,3809,1972,1749,323,2849,2255,458,2771,1614,3192,2633,3458,2109,3870,7,335,4083,1992,1840,1828,2202,3986,168,1085,2589,598,1870,1954,987,505,531,1364,2106,3791,3068,1487,1977,1033,67,3317,3472,3575,2861,3651,3667,1588,1759,321,3947,2064,1184,3077,2607,3652,546,1056,3779,235,2267,1784,952,3815,3247,1637,1670,2410,3938,2594,458,3455,715,137,1956,1482,3193,1174,1158,1538,1446,2745,2485,731,3630,2016,3527,1109,1260,20,523,2865,2117,2416,470,2222,4052,2023,3362,2967,1836,1487,2291,2706,173,1803,3632,2604,3641,2109,1895,3479,3733,666,3721,2223,3160,26,2552,1128,2267,796,3086,2344,2299,3299,105,3624,3870,177,1874,3418,1907,3427,31,1874,2954,557,1285,2257,2184,2210,3919,2647,2120,995,675,3119,298,1166,2387,664,3607,2320,3908,591,793,1401,2255,3143,3776,4032,3790,3511,2884,3433,782,2227,3276,1576,4055,3134,1971,814,2887,2624,1978,3199,3630,16,2824,3767,4031,643,1637,3695,2334,3059,1481,703,3668,3010,2290,3576,335,1126,3252,1515,31,2248,3328,2005,196,1511,658,2382,2741,3021,2896,2706,2625,461,3098,3808,2378,281,393,396,3815,1990,3580,710,3434,2908,2634,374,354,2245,2481,3185,1762,490,2601,2607,2282,541,1871,467,3036,1590,3291,4019,3613,1276,2502,367,3153,316,3132,83,744,4054,3669,244,1025,3153,1344,1740,1716,2230,1037,3775,2475,3400,3395,3956,2250,1729,1445,1420,829,3458,2426,901,1987,1728,1156,1069,2916,853,1471,2632,609,1387,2106,3844,3205,3407,3448,3836,1238,2479,2394,107,630,3265,674,348,245,1122,2320,1357,3520,2987,471,773,2808,1871,1842,1214,2650,3991,2324,1005,1080,2465,1510,969,3794,590,3447,3091,2623,2153,1531,1393,2091,2443,1714,1998,3602,2599,2882,3922,2574,3679,2068,2048,2647,2095,3923,1428,1973,1043,3954,1481,1760,1718,3218,1555,2533,1,3255,2605,444,208,3297,126,714,316,479,2971,2948,2622,2468,2549,2898,3661,749,3042,880,271,4075,2122,31,2194,737,2055,184,3975,2957,1223,3852,207,2219,4016,2489,2717,3990,3951,3000,3833,2688,3377,1386,2533,2086,3812,2432,189,3077,3426,3753,1442,2679,609,1480,2999,339,3454,3288,3415,693,2819,2860,3354,3367,1322,3228,787,3983,430,3023,3155,3308,2913,1863,1661,1610,3712,3596,1081,596,3249,92,6,1496,1692,215,2099,980,3176,3947,239,4006,919,1934,364,638,1492,2896,3794,884,2794,235,4028,2049,1020,1732,3,3509,2932,338,2578,2273,2825,3127,718,3840,365,2637,3509,224,322,1582,3393,2993,3529,3315,3372,985,2831,3080,133,2591,1277,3315,450,2294,3498,4081,2887,3414,2535,2915,506,2751,2040,3140,2346,464,1423,3008,3401,1551,2734,2843,1452,3145,3450,2346,3843,879,913,2385,1768,1707,2293,1129,3343,2068,385,2925,2519,664,2591,4031,3408,1844,1081,2186,2021,911,2511,3591,3187,3453,2495,2326,2959,1235,1764,3955,1405,3077,1415,568,3448,998,801,3959,1547,1868,196,1903,201,1146,2814,3291,1097,92,1373,2627,2633,1017,40,2628,1183,1351,381,2956,2229,4,4010,4067,73,113,4065,2079,2801,4060,3727,3351,3869,3579,2813,169,438,760,1390,2040,3582,596,3910,1072,2420,1552,254,1342,3364,1850,1700,2625,4028,812,3255,1033,926,2034,2172,2762,3277,3766,706,580,3244,3807,413,96,2589,2775,129,1267,1695,3042,226,2702,554,784,980,2449,87,2747,3950,511,1480,297,2828,2487,3615,1865,938,855,466,2468,69,828,2655,183,2369,3632,2693,3114,2873,2017,2974,2999,1047,2744,3671,2715,3673,1028,700,478,417,1074,1171,240,3829,2356,3169,790,3887,1558,970,2769,525,424,1804,157,3575,2751,3815,1731,2512,1989,2823,3621,318,616,3624,2080,1947,2446,2007,1213,2828,53,3616,59,2158,3670,16,548,3506,977,3982,3440,1773,2774,2134,1020,3464,2271,129,1402,4005,2639,2147,3727,482,419,2766,3622,3586,809,665,861,1403,1426,2994,1573,2171,1383,2891,3246,3894,3663,18,2879,3623,650,3484,3845,1703,1415,2790,1483,2048,3632,1896,3855,1759,1840,1241,3822,1517,1430,2659,3364,3640,2804,811,3686,4025,3430,2316,2369,3556,1617,2223,3536,2084,2332,2779,1699,496,2503,3483,750,1288,2115,566,2995,325,4052,63,3434,3138,1977,1108,183,2341,1560,2786,3183,3591,3192,3089,4081,3352,1434,3279,3609,1678,69,816,3025,3661,2673,1978,1202,705,738,988,2390,2131,2797,750,3447,1923,1165,594,3874,2981,1950,2482,193,3136,761,754,3323,3113,606,3639,3083,528,3584,2620,3761,2681,3862,635,1160,1799,2453,3362,1243,821,2666,2870,2072,1330,2490,1183,1619,677,1252,1121,1867,422,3622,1163,525,182,899,173,887,2124,881,525,3461,2030,1973,333,3046,294,3565,1733,393,2759,2834,1107,3360,3784,1123,2775,1283,3209,3952,3562,2540,3238,827,3589,2380,3963,538,2835,448,827,346,2866,1645,20,794,3425,3446,211,2969,1423,1839,4024,2889,1631,3399,4006,1612,1206,3153,1802,3182,2603,2119,2670,1932,503,3733,3131,260,4061,2309,855,628,3330,3444,2499,576,2037,844,416,3526,145,4057,298,1548,1633,1762,1755,439,2259], "corriente":[2160,832,1821,3856,3120,2962,2997,3440,3580,2177,2038,251,2155,2512,3501,2246,2184,3650,2648,2343,990,697,3319,324,2614,1001,2917,1474,4073,3307,3843,1689,3057,3009,2055,3647,3678,3553,357,693,166,3860,191,874,2854,2999,2681,1490,3155,2830,1439,9,3113,1543,2411,2945,3993,2038,3572,2738,3261,1605,272,339,788,3382,783,1221,3479,3502,2585,2934,3426,2822,1102,39,253,4075,1020,1799,3488,3780,4033,2293,996,2056,1163,956,601,2570,1355,26,1735,321,228,2500,879,117,1995,1103,3511,486,3845,344,3068,3141,2260,3126,3660,3879,3065,959,4063,2651,346,1234,2922,2613,2966,1734,1698,101,3838,1775,196,1767,2531,915,2110,1992,3195,1375,245,533,2955,2295,1139,3436,556,2694,4082,1782,2512,3369,2183,353,1375,3897,337,1597,675,376,1637,1673,434,60,1119,3153,2244,308,2619,2065,469,2338,2884,2737,4044,1410,2928,3768,1536,750,3805,1835,3486,1368,2046,853,2134,528,501,2504,1339,3566,3274,946,1267,3150,2059,3812,1680,3861,937,3186,2557,1791,3492,2672,3276,4064,1812,732,1474,1744,2937,1981,709,3369,1193,1319,2980,1010,2760,1834,309,2498,594,2489,3903,2687,3129,2653,1431,1850,44,3158,1081,1265,2518,332,3496,2833,3622,2066,3391,1493,958,3979,1585,1408,2449,2227,361,2271,3451,2564,1626,2488,371,692,610,3836,3665,327,349,3532,1359,3253,154,1443,1902,2426,367,714,888,459,1492,1388,3422,96,1305,3759,342,961,2751,4070,3900,1879,231,3244,1364,2337,2129,3006,910,1329,2215,637,1170,990,2739,2828,1745,1469,2765,3389,1173,1073,2361,963,63,353,628,3001,655,3266,2915,187,1829,2034,3099,3644,3224,416,899,1932,3288,3353,1021,2982,3119,374,555,2565,1590,754,3639,3866,239,2559,2105,1787,1149,956,515,244,280,1544,2361,2849,953,2383,3196,1963,3057,2251,3338,4070,1870,840,581,2353,498,1655,978,531,3633,622,427,4087,1072,3802,593,1743,2178,636,1743,3178,1545,1759,1917,3159,3997,2617,3143,2942,271,1385,2482,2852,542,2017,1121,1732,533,1022,2260,2894,1188,697,2216,2442,3297,1419,1258,3087,1680,160,3916,358,3077,584,612,928,1237,2667,4059,547,708,993,1717,908,3634,4088,1734,1221,632,840,3197,3670,3808,2583,2018,3809,501,1988,2760,3520,82,441,2385,103,1456,2993,1389,140,3036,3985,2831,3329,3062,795,1743,2168,1731,700,328,1446,2350,3943,1119,3735,1625,3350,1400,2174,1445,2502,1592,292,1665,2418,3875,1278,2798,3071,594,1359,2473,2104,3526,3423,153,358,1082,1936,3007,3305,427,3503,3647,533,2648,3260,3186,306,1395,2961,3675,1157,705,2636,1394,129,2135,3175,1698,2818,715,2039,1604,3236,2095,1012,1234,68,591,3604,1277,634,3502,2430,1500,2397,389,2263,2596,2597,3926,1188,197,2997,927,1763,3171,2299,27,932,240,3854,1231,1500,1737,1361,309,1128,1053,29,3483,2766,4016,328,1693,1751,2845,692,3098,2041,2721,1098,498,75,3346,1772,1310,923,2384,335,238,4090,424,3303,2630,3959,3717,389,1699,112,1308,2416,102,3295,1895,627,3962,3173,463,411,1307,139,3749,725,3596,3055,3218,1494,1096,2603,3431,2719,176,773,1208,2691,1396,1464,1830,3881,3918,2726,1266,129,1877,3958,2438,1263,176,3530,3030,251,479,2758,3377,1804,2977,3230,234,2001,3450,3273,1387,984,264,204,1757,4047,2769,1025,2923,3013,2045,3419,3480,1771,3662,2800,2194,1237,1129,4054,698,2057,713,1177,2834,167,2128,3940,1599,277,3738,2070,3577,1543,760,3728,4038,2042,3134,3812,2713,3408,256,424,712,1740,441,800,2041,1756,3513,3039,2956,372,3352,3520,3125,1097,2112,3057,1461,1991,1209,2995,1959,374,2646,962,3798,588,2264,3976,3711,1773,2802,1498,1964,1977,3405,2844,2902,3140,3051,3071,2336,3346,3037,3020,4082,2276,101,1401,2227,1602,2175,3582,609,2329,1024,9,949,3036,2142,3920,2926,728,2218,907,395,1069,1644,1846,2532,225,3112,1439,2511,1346,1794,2581,2106,2039,1507,2934,2300,931,3062,162,89,1695,3661,3228,2956,3421,2558,166,1065,1273,968,3111,838,2235,3089,2369,718,1345,912,3023,1852,886,1896,3493,2035,3688,1294,2617,2150,617,3593,3510,3560,2599,2721,3934,3544,5,2615,3903,1776,1968,1086,1446,2937,421,268,2825,3560,1879,1155,2730,754,2674,3858,3337,930,2556,4087,2460,2588,754,1769,1296,315,3600,3196,3075,1843,240,3193,2637,882,1431,403,3496,2357,1072,1170,3564,2691,2942,2089,2018,3546,2794,1329,3889,1333,3941,3935,1892,2056,1783,1965,3263,3468,449,1803,2468,2896,876,698,1266,261,1115,1968,2749,3452,3771,590,3595,3961,2773,2839,3985,3497,3391,898,1789,3,394,492,1393,2889,1568,2417,1367,420,1623,2601,3588,1973,1628,3969,3427,3542,3783,3083,2786,69,1478,3668,2603,2399,2111,2782,3747,3728,1962,607,78,1657,617,3880,622,984,1787,3246,3198,460,2290,75,699,307,313,919,196,3750,1780,283,1536,803,2943,3565,3843,942,3426,2140,1379,972,1707,3905,858,1499,3711,2274,683,3290,2091,3816,2532,2654,2424,2035,2328,805,3490,1718,522,2256,904,714,3378,3335,3152,2743,312,3894,3258,3310,198,733,490,2134,2128,945,283,860,631,798,1962,1688,2419,1188,1297,53,2851,1387,2270,2652,3270,2277,338,3073,572,3342,658,913,1079,2261,2505,964,3124,2053,1839,2622,1282,3321,3854,2456,3545,1613,134,4012,3597,1077,3434,1070,166,1572,1112,2589,2570,1975,532,231,810,1915,625,1775,418,278,3177,3669,2402]}'
~~~
Cada vez que hace hace un cambio se tiene que re-desplegar la web app


### Pruebas

## Compilación ESP32

### Librerías

* HTTPSRedirect https://github.com/electronicsguy/HTTPSRedirect

### Linux

Libreria ESP32 version 2.X

Permisos para el puerto:

~~~shell
$ lsusb
...
Bus 001 Device 055: ID 10c4:ea60 Silicon Labs CP210x UART Bridge
...
~~~

~~~shell
$ ls -al /dev/ttyUSB0
crw-rw---- 1 root dialout 188, 0 jun 17 09:55 /dev/ttyUSB0
~~~

Aca notamos que el dispostivo esta solo para el grupo `dialout` así que procedemos a agregar el usuario con que se lanza la IDE (`$USER`) al grupo `dialout` y (`tty`):

~~~shell
$ sudo usermod -a -G dialout $USER
$ sudo usermod -a -G tty $USER
$ sudo chmod a+rw /dev/ttyUSB0
~~~

Cada vez que se conecte
~~~shell
$ lsusb
...
Bus 001 Device 003: ID 10c4:ea60 Silicon Labs CP210x UART Bridge
...
$ ls -al /dev/ttyUSB*
crw-rw---- 1 root dialout 188, 0 jun 18 12:38 /dev/ttyUSB0
$ sudo chmod 0666 /dev/ttyUSB0
$ ls -al /dev/ttyUSB*
crw-rw-rw- 1 root dialout 188, 0 jun 18 12:38 /dev/ttyUSB0./
~~~